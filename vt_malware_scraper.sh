#!/bin/bash
##sudo service tor start
counter=1
echo "Virustotal Malware Scraper"
for i in {1..5} # number of pages for each profile to scrape (1-$i)
do
#Download User Kronk samples (pages 1-"$i")
echo
echo "Downloading Kronk Page $i"
curl -o $HOME/virustotal/INFECTED/vt_malwarescrape_Kronk$i.html --socks5 127.0.0.1:9050 https://www.virustotal.com/en/user/Kronk/comments/?page=$i&_=1366925720113
sleep 10
#download user Seyhoo (pages 1-"$i")
echo
echo "Downloading Seyhoo Page $i"
curl -o $HOME/virustotal/INFECTED/vt_malwarescrape_Seyhoo$i.html --socks5 127.0.0.1:9050 https://www.virustotal.com/en/user/Seyhoo/comments/?page=$i&_=1367273046209
sleep 10
done
cat $HOME/virustotal/INFECTED/vt_malwarescrape*.html | grep --only-matching --perl-regexp "h[txX][txX]p(s?):\/\/[^ \"\(\)\<\>]*" | sed 's/\\n//' | sed 's/hXXp/http/' | sed 's/hxxp/http/' | sort | uniq > $HOME/virustotal/logs/malwarelist
#consolidating malware lists
rm -f $HOME/virustotal/INFECTED/vt_malwarescrape*.html
cd $HOME/virustotal/INFECTED
#Making master file for all downloaded malware links
echo "--------------------" >> $HOME/virustotal/logs/malwarelist_master
echo "Malware from $(date +%Y-%m-%d-%I%M)" >> $HOME/virustotal/logs/malwarelist_master
echo "--------------------" >> $HOME/virustotal/logs/malwarelist_master
cat $HOME/virustotal/logs/malwarelist >> $HOME/virustotal/logs/malwarelist_master
echo 'Downloading Malware'
#parse each line of malwarelist and download file via tor
for i in $(cat $HOME/virustotal/logs/malwarelist) ; do echo; echo "Downloading sample $counter"; echo $i; curl -O $i --socks5 127.0.0.1:9050 ; let "counter += 1"; done
#cleanup and organization
echo "Extracting zip files"
unzip '*.zip'
mkdir $(date +%Y-%m-%d-%I%M)
find . -maxdepth 1 -type f -exec mv {} $(date +%Y-%m-%d-%I%M) \;
cd $(date +%Y-%m-%d-%I%M)
#compare to hash.cymru for malware results
echo "begin" > hashes
md5sum * | cut -d " " -f1 >> hashes
echo "end" >> hashes
netcat hash.cymru.com 43 < hashes > hashes_returned
echo "Returned Hashes from CYMRU"
cat hashes_returned | cut -d ' ' -f1,3 | grep -v NO_DATA | grep -v \#
#cleanup
rm hashes hashes_returned
mv $HOME/virustotal/logs/malwarelist $HOME/virustotal/logs/malwarelist_$(date +%Y-%m-%d-%I%M)